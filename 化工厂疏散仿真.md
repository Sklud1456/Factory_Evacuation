## 化工厂疏散仿真

#### 问题背景

​		近年来，随着化学工业的迅猛发展，危险化学品在运输、储存、生产、使用过程中重大的事故频繁发生，尤其是危险化学品生产的企业，在其存储、使用、生产过程中发生泄漏，遇到火源就会发生火灾甚至是爆炸事故、一旦发生火灾爆炸事故，给化工厂内的工作人员生命安全带来了极大的威胁。如何在火灾、爆炸等事故发生时，有效及时地将化工厂内的有关人员进行安全疏散，已成为化工生产企业重大的安全课题。

#### 问题要求

​		1.针对化工厂疏散这一情景通过算法进行仿真。

​		2.采用智能体模拟个体，实现多智能体的逃生。

​		3.对于不同的情况进行比对分析，考虑不同的逃生策略。

#### 符号注释表

| 符号                               |            含义            |
| :--------------------------------- | :------------------------: |
| v~ix~，v~iy~                       |     前元胞的x、y坐标值     |
| v~ox~，v~oy~                       |    邻居元胞的x、y坐标值    |
| r                                  |          邻居半径          |
| X~min~，Y~min~，X~max~，Y~max~     |     建筑场景的上下坐标     |
| X~smin~，Y~smin~，X~smax~，Y~smax~ |    初始恐惧场的上下坐标    |
| X~qmin~，Y~qmin~，X~qmax~，Y~qmax~ |     区域场景的上下坐标     |
| Q                                  |   所有区域的上下坐标集合   |
| P~x~，P~y~                         |        疏散人员坐标        |
| S                                  |        模拟场景点集        |
| K                                  |     扩散触发器随机变量     |
| speed，speed~h~                    | 疏散人员速度和受伤人员速度 |
| hurt                               |          受伤程度          |

#### 实现细节

​		对于特定情景进行的算法模拟仿真，需要将现实情况映射到程序算法中，所以需要对问题进行建模。

##### 模型选择

​		近年来，国内外的不少学者已经提出了数十种人员疏散的动力学模型，其简单可以分为连续模型和离散模型。连续模型一般通过函数来定义疏散人员的行为，常见的连续模型有社会力模型、流体力学模型等。而离散模型则是将疏散场景在时间或空间离散化，使疏散行为在离散的场景下演化。而对于化工厂这一较大的场景中，采用离散模型也可以在宏观尺度上达到类似连续模型的效果。本文将采用离散模型中的元胞自动机对该疏散场景进行模拟，元胞自动机能够具体化个体特征，并通过将大范围相互作用转化为小范围相互作用，显著减少计算复杂度，拥有独特的优势。

##### 元胞自动机的建立

​		由于采用了元胞自动机模型，所以需要对其设立的过程进行介绍。

###### 几何划分方式

​		由于化工厂的几何形态比较方正，所以本文采用了经典的四边形网格的划分方式对元胞自动机进行建模。并采用了扩展的摩尔（Moore）型的邻居模型，其公式表达如下：
$$
N_{Moore}=\{v_i=(v_{ix},v_{iy})||v_{ix}-v_{ox}|\leqq r,|v_{iy}-v_{oy}|\leqq r,(v_{ix},v_{iy})\in z^2\}
$$
上式中，v~ix~，v~iy~，v~ox~，v~oy~，分别表示当前元胞的x、y坐标值和邻居元胞的坐标值，r为邻居半径。

###### 建筑场景的设定

| ![1](.\img\1.png) | ![2](.\img\2.png) |
| :---------------: | :---------------: |

<p align="center">图1-1 化工厂地图和还原情况</p>

​		本文在将根据一张化工厂平面设计的图纸对化工厂的设施进行还原，原图纸的设计长宽为300m×220m，而在程序中，则缩小至100×75，为原来的1/3。其单位为元胞自动机中的网格大小（即网格尺寸的大小为3m）。而在显示方面，则通过10倍大小映射到显示端，即厂区的大小为1000px×750px，使其在演示的方面能够有更好地显示效果。

​		对于每一个建筑矩形所需要的参数在图纸中也有标注，即为X~min~，Y~min~，X~max~，Y~max~，通过这四个值可以确定该建筑的左下角坐标和右上角坐标，通过二点矩阵画法的方式来确定该建筑的位置和大小。

###### 势能场的设计与实现

​		在物理学中，电场中的电压表示电场中带正电电荷在此处的势能，而在电场力的作用下，正电荷总是从高电势能处向低势能处运动，而与物理学概念类似，在元胞自动机中，智能体在运动中也会随着整体的势能场从高势能处逐步运动到低势能处。

​		在势能场的建立中，势能取决于该网格与出口之间的距离，出口的势能设置为1，与这些网格相邻的网格移动势能依次递增，如此反复直到疏散空间S内的所有的网格都被赋予了相应的势能值。
| ![3](.\img\3-1.png) | ![3](.\img\3-2.png) |
| :---------------: | :---------------: |

<p align="center">图1-2 不同的出口局部势能分布情况</p>

​		由于化工厂会设置多个出口，所以需要考虑多个出口的势能分布情况，将二者相结合。以5×5的简单网格势能场为例。出口A和出口B的局部移动势能分布情况如图1-2所示。在图1-2中，红圈所在网格M表示智能体所在的位置，则网格M对于出口A和出口B的局部移动势能分别为M(A)=4，M(B)=2。若单纯考虑一个出口的局部移动势能，则智能体位于左图，则该智能体会往上走；若其位于右图则该智能体则会向下走。而根据最短路径原则，应该选择B作为出口，所以如果同时出现多个出口仅考虑一个出口所带来的势能场是不可靠的，需要进行全局的考量。而在化工厂疏散这一多出口的情景，则需要考虑多个出口所带来的全局势能的变化，如下图所示：

![3](.\img\3-3.png)

<p align="center">图1-3 不同的出口全局势能分布情况</p>

​		全局移动势能是当疏散场景有多个出口的时候，网格所具有的移动势能。它会将所有出口的局部移动势能汇总在一起，然后取每个网格的最小值，最终得到全局移动势能分布图，如图1-3在多个出口的情况下，智能体的选择会更加丰富，上方的智能体会选择出口A，而下方的智能体则会根据自己的位置感知最近的出口，从而选择出口B，使得疏散这一行为更加合理，人性化。

​		势能场的计算公式可由下面的代码表示：

```
将势能矩阵minDis矩阵值置为无穷大
遍历多个出口：
	遍历每个出口中的网格坐标：
		//采用BFS来遍历地板场
		设立一个临时势能tmp
		将网格坐标进入队列queue
		将出口的势能值设为1
		while queue不空:
			queue出队一个坐标并获取其势能值dis
			依次遍历出队坐标的邻居:
				if 邻居坐标非障碍值 and 邻居坐标尚未赋势能值：
					该邻居坐标入队
					tmp中的邻居坐标势能值=dis+(1 if 该邻居非对角 else 1.4)
		将tmp和minDis比对，将其中的较小值赋值给minDis//全局移动势能
最终的minDis就是势能场
```

​		其算法复杂度为O(n*m)，n和m分别为疏散空间的长宽。

​		考虑到使用元胞自动机的模型和势能下降的移动算法的缘故，智能体的行动轨迹会出现紧贴着建筑物的情况，而与现实生活中在马路上疏散的情况不符，于是本文在其中对建筑周围的势能进行了人为地提高，防止智能体出现紧贴墙体的情况，并与原本的策略进行对比。效果图如下：

| ![8](.\img\8-1.png) | ![8](.\img\8-2.png) |
| :-----------------: | :-----------------: |
|    建筑势能扩大     |   建筑势能不扩大    |

<p align="center">图1-4 建筑势能扩大对比图</p>	

​		提高建筑势能的算法如下：

```python
遍历每个建筑：
	将其外围1格的势能值设为原值+200
遍历每个危险区域
	将其外围2格的势能值设为inf
```

###### 危险区域的扩散

​		结合化工厂疏散的实际情况，在疏散仿真中并不是所有的智能体都会第一时间得知化工厂发生爆炸的消息。因此，根据这个情况，本文增加了危险扩散的算法，实现方式比较简单。扩散会以K的值为触发器进行触发，而K是一个关于时间t的固定分布的随机变量，其概率密度函数为：
$$
f(k)=
\begin{cases}
\varphi, t\geq 5\\
0, 其他\\
\end{cases}
$$
五秒过后的每一秒，其都已φ（在本文中取0.5）的概率进行扩散，在本文中，设置扩散一次就会停下。其扩散的坐标也在危险区域附近进行随机生成。其效果如下图：

![4](.\img\4.png)

<p align="center">图1-5 危险区域扩散示意图</p>		

​		疏散中的智能体也会实时感知到生成的新的障碍区域，从而更改自己的疏散路线，选择更加安全且便利的路线。

###### 疏散人员的种类设置

​		由于真正发生化工厂爆炸事件的时候，会造成人员的伤亡，而这一点模拟是现实演习中难以实现的，所以需要在虚拟现实中进行模拟。对此，本文将人员的种类分为三类，正常人员，伤员和死者。三者的颜色分别为黑色，黄色和红色。

​		正常人员暂且不表，伤员和死者将会以一定的概率出现在爆炸点的附近。

​		在爆炸点的附近七八米之内，会以一定概率出现伤员，受伤会影响伤员的速度。伤员会根据受伤的程度影响行进速率。影响的公式如下：
$$
speed_h=speed*(1-0.3*hurt)
$$
而当智能体直接被扩散的爆炸物覆盖时，则会出现死亡。

###### 疏散人员分布的设置

本文提供了两种不同的方式来设置人员的初始位置。

（1）全局随机分布

​		全局随机分布直接将用户指定数量的智能体随机分布在整个疏散场景的人员可达区域上。公式如下：
$$
P_{x}=X_{min}+int((X_{max}-X_{min}+1)\times R1)
$$

$$
P_{y}=Y_{min}+int((Y_{max}-Y_{min}+1)\times R2)
$$

其中的P~x~，P~y~表示智能体的坐标，R1，R2为随机数，取值范围为[0,1)。在生成时也会对其坐标进行判断，防止生成在建筑物内部。

```
新建一个人物列表Plist
while 生成人数小于指定人数：
	随机生成newP
	如果newP的坐标值合适:
		将newP加入到人物列表Plist中
```

（2）指定位置生成

​		考虑到疏散模拟的全面性，本文还可供用户在界面上实时添加智能体。通过采集鼠标在canvas上的坐标位置，映射到势能地图网格中用于实现实时的智能体添加。同时通过更改其颜色，可以更直观的展现人群中某些人的运动轨迹，方便之后对其进行行为的分析和观察。

（3）分区域生成

​		考虑到实际的情况，人员并不是随机分布在整个厂区内部的，而是聚集在建筑附近。同时考虑到不同建筑的功能不同，人员的数量也不同，所以按照一定的比例在每个功能区进行人员的随机生成，分配的比例如下：

|   厂区   | 行政区域 | 化验区域 | 仓库区域 | 储罐区域 | 车间区域 | 消防区域 | 机房三废区域 |
| :------: | :------: | :------: | :------: | :------: | :------: | :------: | :----------: |
| 人数比例 |   0.2    |   0.2    |   0.05   |   0.15   |   0.25   |   0.05   |     0.1      |

其生成方式还是随机生成，公式与第一种方式类似：
$$
P_{x}=\sum_{q \in Q}X_{qmin}+int((X_{qmax}-X_{qmin}+1)\times R1)
$$

$$
P_{y}=\sum_{q \in Q}Y_{qmin}+int((Y_{qmax}-Y_{qmin}+1)\times R2)
$$

其中各个符号的含义与（1）中类似。

​		三种不同方式的生成效果如下图：

| ![5](.\img\5-1.png) |  ![5](.\img\5-2.png)  |  ![5](.\img\5-3.png)  |
| :-----------------: | :-----------------: | :-----------------: |
| 随机生成 | 指定位置生成 | 按比例生成 |

<p align="center">图1-4 不同方式生成智能体的效果演示</p>

###### 运动演化规则

​		对于智能体来说，将直接根据势能场进行路径的选择。每个智能体将会观察四周的网格情况，判断出最优的下一步路线。伪代码如下：

```
新建choice列表
遍历八个方向：
	dx=方向*速度
	dy=方向*速度
	下一个坐标值=当前坐标值+偏移量
	if 下一个坐标值合理 and 下一个坐标值中智能体数量小于2：
		将该坐标值加入choice列表
遍历choice找到势能下降最快的路径
```

单个智能体的算法复杂度为O(e)，e为方向数量，而总体的复杂度为O(n*e)，n为智能体总数。

​		其中智能体速度的选择会他感知到的周围的人群密度进行实时变化：
$$
speed=
\begin{cases}
random(1.1,1.3), h\le2\\
random(0.9,1.1), h\le4\\
random(0.7,1.0), h\le7\\
random(0.6,0.7), h>7
\end{cases}
$$
上述公式中的h为该智能体八邻域中的其余智能体总数。

​		通过智能体针对自身邻域的判断从而自动的寻路，可以使得智能体慢慢向出口靠近，达成疏散模拟的效果。但是在现实生活中，事故发生需要一个传播的过程，在本文中采用了地板场扩散的方式进行模拟。

$$
ScareScale=\{(x,y)|X_{smin}-\psi t\le x\le X_{smax}+\psi t,Y_{smin}-\psi t\le y\le Y_{smax},(x,y)+\psi t\in S\}
$$
上述公式中 X~smin~，Y~smin~，X~smax~，Y~smax~，这四个值可以确定初始恐惧场的左下角坐标和右上角坐标。ψ为设定的系数，t为时间，通过上述方式实现恐惧场随着时间进行扩散。

#### 模拟结果

​		下图是模拟中的截图：

<img src=".\img\6.png" alt="5" style="zoom:50%;" />

<p align="center">图2-1 演示图</p>

​		在疏散模拟结束后，还会有热力图来显示疏散过程中的人群分布和路线。

<img src=".\img\7.png" alt="6" style="zoom:50%;" />

<p align="center">图2-2 最终疏散热力图</p>

###### 不同疏散情况的对比

​		疏散仿真最重要的还是对于各个方式的疏散效果的对比，由此来为现实中的疏散提供直观的依据和借鉴的方式。因此，本文将对不同的疏散方式，不同的疏散效果进行对比。从而分析出其中的区别和一些值得注意的点。在疏散中速度系数设置为1。同时所有实验都会进行十次取平均值。

（1）建筑势能场扩大的对比：

​		由于元胞自动机下的智能体的行为逻辑主要是根据势能场的高低来进行判断，所以在其中的智能体很容易出现“贴墙走”这一不太符合正常行为逻辑的疏散方式。所以本文对此进行了改进，在建筑周围拔高了势能场的势能，并对此进行了对比实验。实验结果如下图，可以看到，由于拔高的势能场，变相缩小了智能体的行进路线，所以智能体疏散的时间都有所增加，但是在人数增加后，其时间差则会变小。这是由于人数增加导致疏散时间拉长，所以原本由于疏散路线限制对疏散时间所造成的影响就会变小。


| 人数 | 建筑势能不扩大疏散 | 建筑势能扩大疏散 |
| :--: | :----------------: | :--------------: |
|  50  |       41.3s        |      49.04s      |
| 100  |       42.66s       |      52.33s      |
| 200  |       46.97s       |      55.16s      |
| 300  |       52.49s       |      67.05s      |
| 400  |       64.7s        |      69.78s      |
| 500  |       78.15s       |      80.56s      |
| 600  |       93.23s       |      97.45s      |
| 800  |      117.26s       |     121.89s      |

<p align="center">表3-1 建筑势能扩大与否的时间对比</p>

![chart](.\img\chart1-1.png)

<p align="center">图3-1 建筑势能扩大与否的时间对比</p>

（2）同时疏散和恐惧扩散疏散的情况对比：

​		考虑到现实中并不会像拟真一般一起疏散，而是有一个信息的传递过程，因此本文也将恐惧扩散的因素进行考虑，与同时疏散进行对比，可以看到恐惧扩散疏散会比同时疏散的扩散时间普遍上都会慢。但在人数过少时并没有很大差距，这是因为人数过少时的疏散时间都会取决于离地图最远的人的疏散时间，这一点二者是类似的。

| 人数 | 同时疏散 | 恐惧扩散疏散 |
| :--: | :------: | :----------: |
|  50  |  43.81s  |    43.61s    |
| 100  |  42.36s  |    49.16s    |
| 200  |  45.04s  |    51.3s     |
| 300  |  53.28s  |    63.96s    |
| 400  |  58.9s   |    73.21s    |
| 500  |  76.82s  |    84.3s     |
| 600  |  80.84s  |    98.92s    |
| 800  | 116.93s  |    129.3s    |

<p align="center">表3-2 恐惧扩散与否的时间对比</p>

![chart](.\img\chart2-1.png)

<p align="center">图3-2 恐惧扩散与否的时间对比</p>

​		下表是伤亡人数与疏散总人数之间的关系图，可以看到，受伤的人数会随着疏散人数慢慢增长，同时约为线性关系，但是死亡人数的增长并不明显，不过在人数骤增至800人时出现了大幅上涨，而且在实验模拟中，只有800人数疏散过程每次都会出现死亡，这估计是因为人数增加导致疏散效率变低，从而导致死亡人数的大大提升。

在仿真中也发现了一个现象：死亡人员一般由受伤人员转化而来。这一点可以映射到现实生活中，由于受伤导致无法及时疏散则会比正常人员更易导致死亡。

![chart](.\img\chart3.png)

<p align="center">图3-3 伤亡人数与疏散人数的关系</p>

#### 结论和感想

​		本文通过元胞自动机的模型构建了一个化工厂疏散拟真的模型，在其中有着对化工厂地图还原，疏散的模拟，恐惧情绪扩散模拟等等功能，是一个针对化工厂疏散这一现实问题具有良好拟真效果的模型。在构建完模型后，本文还进行了重复的拟真实验，用来探寻疏散中出现的各种问题。对于其中的一些现象也做出了分析，也进行了数据的分析和汇总。

​		虚拟现实虽然是虚拟的，但在一定的程度上可以反映现实，在虚拟中模拟现实，是为了弥补现实中的一些难以实现的方案，从而能够更好地去回馈现实，帮助现实。因此虚拟现实离不开现实，它更应当做为现实的补充，去为现实查漏补缺，而不是完全脱离现实。
