## 化工厂疏散仿真

#### 问题背景

​		近年来，随着化学工业的迅猛发展，危险化学品在运输、储存、生产、使用过程中重大的事故频繁发生，尤其是危险化学品生产的企业，在其存储、使用、生产过程中发生泄漏，遇到火源就会发生火灾甚至是爆炸事故、一旦发生火灾爆炸事故，给化工厂内的工作人员生命安全带来了极大的威胁。如何在火灾、爆炸等事故发生时，有效及时地将化工厂内的有关人员进行安全疏散，已成为化工生产企业重大的安全课题。

#### 问题要求

​		1.针对化工厂疏散这一情景通过算法进行仿真。

​		2.采用智能体模拟个体，实现多智能体的逃生。

​		3.对于不同的情况进行比对分析，考虑不同的逃生策略。

#### 符号注释表

| 符号             |         含义         |
| :--------------- | :------------------: |
| v~ix~，v~iy~     |  前元胞的x、y坐标值  |
| v~ox~，v~oy~     | 邻居元胞的x、y坐标值 |
| r                |       邻居半径       |
| X~min~，Y~min~   | 建筑场景的左下角坐标 |
| X~max~，Y~max~   | 建筑场景的右上角坐标 |
| P~x~，P~y~       |     疏散人员坐标     |
| X~smin~，Y~smin~ | 初始恐惧场左下角坐标 |
| X~smax~，Y~smax~ | 初始恐惧场右上角坐标 |
| S                |     模拟场景点集     |
|                  |                      |



#### 实现细节

对于特定情景进行的算法模拟仿真，需要将现实情况映射到程序算法中，所以需要对问题进行建模。

##### 模型选择

近年来，国内外的不少学者已经提出了数十种人员疏散的动力学模型，其简单可以分为连续模型和离散模型。连续模型一般通过函数来定义疏散人员的行为，常见的连续模型有社会力模型、流体力学模型等。而离散模型则是将疏散场景在时间或空间离散化，使疏散行为在离散的场景下演化。而对于化工厂这一较大的场景中，采用离散模型也可以在宏观尺度上达到类似连续模型的效果。本文将采用离散模型中的元胞自动机对该疏散场景进行模拟，元胞自动机能够具体化个体特征，并通过将大范围相互作用转化为小范围相互作用，显著减少计算复杂度，拥有独特的优势。

##### 元胞自动机的建立

由于采用了元胞自动机模型，所以需要对其设立的过程进行介绍。

###### 几何划分方式

由于化工厂的几何形态比较方正，所以本文采用了经典的四边形网格的划分方式对元胞自动机进行建模。并采用了扩展的摩尔（Moore）型的邻居模型，其公式表达如下：
$$
N_{Moore}=\{v_i=(v_{ix},v_{iy})||v_{ix}-v_{ox}|\leqq r,|v_{iy}-v_{oy}|\leqq r,(v_{ix},v_{iy})\in z^2\}
$$
上式中，v~ix~，v~iy~，v~ox~，v~oy~，分别表示当前元胞的x、y坐标值和邻居元胞的坐标值，r为邻居半径。

###### 建筑场景的设定

| ![1](.\img\1.png) | ![2](.\img\2.png) |
| :---------------: | :---------------: |

<p align="center">图1-1 化工厂地图和还原情况</p>

本文在将根据一张化工厂平面设计的图纸对化工厂的设施进行还原，原图纸的设计长宽为300m×220m，而在程序中，则缩小至100×75，为原来的1/3。其单位为元胞自动机中的网格大小（即网格尺寸的大小为3m）。而在显示方面，则通过10倍大小映射到显示端，即厂区的大小为1000px×750px，使其在演示的方面能够有更好地显示效果。

对于每一个建筑矩形所需要的参数在图纸中也有标注，即为X~min~，Y~min~，X~max~，Y~max~，通过这四个值可以确定该建筑的左下角坐标和右上角坐标，通过二点矩阵画法的方式来确定该建筑的位置和大小。

###### 势能场的设计与实现

在物理学中，电场中的电压表示电场中带正电电荷在此处的势能，而在电场力的作用下，正电荷总是从高电势能处向低势能处运动，而与物理学概念类似，在元胞自动机中，智能体在运动中也会随着整体的势能场从高势能处逐步运动到低势能处。

在势能场的建立中，势能取决于该网格与出口之间的距离，出口的势能设置为1，与这些网格相邻的网格移动势能依次递增，如此反复直到疏散空间S内的所有的网格都被赋予了相应的势能值。
| ![3](.\img\3-1.png) | ![3](.\img\3-2.png) |
| :---------------: | :---------------: |

<p align="center">图1-2 不同的出口局部势能分布情况</p>

由于化工厂会设置多个出口，所以需要考虑多个出口的势能分布情况，将二者相结合。以5×5的简单网格势能场为例。出口A和出口B的局部移动势能分布情况如图1-2所示。在图1-2中，红圈所在网格M表示智能体所在的位置，则网格M对于出口A和出口B的局部移动势能分别为M(A)=4，M(B)=2。若单纯考虑一个出口的局部移动势能，则智能体位于左图，则该智能体会往上走；若其位于右图则该智能体则会向下走。而根据最短路径原则，应该选择B作为出口，所以如果同时出现多个出口仅考虑一个出口所带来的势能场是不可靠的，需要进行全局的考量。而在化工厂疏散这一多出口的情景，则需要考虑多个出口所带来的全局势能的变化，如下图所示：

![3](.\img\3-3.png)

<p align="center">图1-3 不同的出口全局势能分布情况</p>

全局移动势能是当疏散场景有多个出口的时候，网格所具有的移动势能。它会将所有出口的局部移动势能汇总在一起，然后取每个网格的最小值，最终得到全局移动势能分布图，如图1-3.在多个出口的情况下，智能体的选择会更加丰富，上方的智能体会选择出口A，而下方的智能体则会选择出口B，使得疏散这一行为更加合理，人性化。

势能场的计算公式可由下面的代码表示：

```
将势能矩阵minDis矩阵值置为无穷大
遍历多个出口：
	遍历每个出口中的网格坐标：
		//采用BFS来遍历地板场
		设立一个临时势能tmp
		将网格坐标进入队列queue
		将出口的势能值设为1
		while queue不空:
			queue出队一个坐标并获取其势能值dis
			依次遍历出队坐标的邻居:
				if 邻居坐标非障碍值 and 邻居坐标尚未赋势能值：
					该邻居坐标入队
					tmp中的邻居坐标势能值=dis+(1 if 该邻居非对角 else 1.4)
		将tmp和minDis比对，将其中的较小值赋值给minDis//全局移动势能
最终的minDis就是势能场
```

其算法复杂度为O(n*m)，n和m分别为疏散空间的长宽。

###### 疏散人员的设置

人员的初始分布本文提供了两种不同的方式来设置人员的初始位置。

（1）全局随机分布

全局随机分布直接将用户指定数量的智能体随机分布在整个疏散场景的人员可达区域上。公式如下：
$$
P_{x}=X_{min}+int((X_{max}-X_{min}+1)\times R1)
$$

$$
P_{y}=Y_{min}+int((Y_{max}-Y_{min}+1)\times R2)
$$

其中的P~x~，P~y~表示智能体的坐标，R1,R2为随机数，取值范围为[0,1)。在生成时也会对其坐标进行判断，防止生成在建筑物内部。

```
新建一个人物列表Plist
while 生成人数小于指定人数：
	随机生成newP
	如果newP的坐标值合适:
		将newP加入到人物列表Plist中
```

（2）指定位置生成

考虑到疏散模拟的全面性，本文还可供用户在界面上实时添加智能体。通过采集鼠标在canvas上的坐标位置，映射到势能地图网格中用于实现实时的智能体添加。效果如下图所示。

![4](.\img\4.png)

<p align="center">图1-4 指定位置生成智能体演示</p>

###### 运动演化规则

对于智能体来说，将直接根据势能场进行路径的选择。每个智能体将会观察四周的网格情况，判断出最优的下一步路线。伪代码如下：

```
新建choice列表
遍历八个方向：
	dx=方向*速度
	dy=方向*速度
	下一个坐标值=当前坐标值+偏移量
	if 下一个坐标值合理 and 下一个坐标值中智能体数量小于2：
		将该坐标值加入choice列表
遍历choice找到势能下降最快的路径
```

单个智能体的算法复杂度为O(e)，e为方向数量，而总体的复杂度为O(n*e)，n为智能体总数。

其中智能体速度的选择会根据人群密度进行实时变化：
$$
f(x)=
\begin{cases}
random(1.1,1.5), h\le2\\
random(0.9,1.1), h\le4\\
random(0.7,0.9), h\le7\\
\end{cases}
$$
上述公式中的h为该智能体八邻域中的其余智能体总数。

通过邻域的寻路，可以使得智能体慢慢向出口靠近，但是在现实生活中，事故发生需要一个传播的过程，在本文中采用了地板场扩散的方式进行模拟。
$$
ScareScale=\{(x,y)|X_{smin}-\psi t\le x\le X_{smax}+\psi t,Y_{smin}-\psi t\le y\le Y_{smax},(x,y)+\psi t\in S\}
$$
上述公式中 X~smin~，Y~smin~，X~smax~，Y~smax~，这四个值可以确定初始恐惧场的左下角坐标和右上角坐标。ψ为设定的系数，t为时间，通过上述方式实现恐惧场随着时间进行扩散。

#### 模拟结果

下图是模拟中的截图：

<img src=".\img\5.png" alt="5" style="zoom:50%;" />

<p align="center">图2-1 演示图</p>

在疏散模拟结束后，还会有热力图来显示疏散过程中的人群分布和路线。

<img src=".\img\6.png" alt="6" style="zoom:50%;" />

<p align="center">图2-2 最终疏散热力图</p>

###### 不同疏散方式的对比
